name: Build Packages

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  arch:
    name: Arch PKGBUILD
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3
      - name: Build package inside Arch container
        run: |
          docker run --rm -v "$PWD:/workspace" -w /workspace archlinux:latest \
          bash -c "
            pacman -Syu --noconfirm git base-devel sudo &&
            pacman -S --noconfirm \
              python python-build python-installer python-uv-build python-wheel \
              gtk4 libadwaita vte4 libsecret rsync sshpass \
              python-gobject python-setproctitle python-requests python-psutil \
              python-regex python-pygments python-cairo gobject-introspection &&
            useradd -m builder &&
            echo 'builder ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers &&
            chown -R builder:builder /workspace &&
            cd pkgbuild &&
            sudo -u builder env PKGVER=${GITHUB_REF##*/v} PKGREL=1 makepkg -s --noconfirm
          "
          sudo chown -R $(id -u):$(id -g) .
      - name: Upload Arch package
        uses: actions/upload-artifact@v4
        with:
          name: zashterm-arch
          path: pkgbuild/*.pkg.tar.zst

  deb:
    name: DEB via fpm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Build wheel
        run: |
          python -m pip install --upgrade pip
          python -m pip install build installer
          python -m build --wheel
      - name: Install fpm toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems build-essential rpm
          sudo gem install --no-document fpm
      - name: Stage files for packaging
        run: |
          set -e
          VERSION="${GITHUB_REF##*/v}"
          mkdir -p pkgroot
          python -m installer --destdir pkgroot dist/*.whl
          mkdir -p pkgroot/usr/bin pkgroot/usr/share
          cp -a usr/bin pkgroot/usr/
          cp -a usr/share pkgroot/usr/
          # Move/copy pure Python site-packages into distro-friendly paths (Deb/Fedora)
          python - <<'PY'
          import pathlib, shutil, sys

          root = pathlib.Path("pkgroot")
          build_py_ver = f"{sys.version_info.major}.{sys.version_info.minor}"
          fedora_py_ver = "3.14"  # current python3 on Fedora
          targets = [
              # Debian-style
              root / "usr/lib/python3/dist-packages",
              root / f"usr/lib/python{build_py_ver}/dist-packages",
              # Fedora-style (versioned, lib64)
              root / f"usr/lib64/python{fedora_py_ver}/site-packages",
              root / f"usr/lib/python{fedora_py_ver}/site-packages",
          ]
          for t in targets:
              t.mkdir(parents=True, exist_ok=True)

          def copy_item(src: pathlib.Path, dest: pathlib.Path):
              if src.is_dir():
                  shutil.copytree(src, dest, dirs_exist_ok=True)
              else:
                  dest.parent.mkdir(parents=True, exist_ok=True)
                  shutil.copy2(src, dest)

          # Collect any site-packages produced under different prefixes (e.g., /opt/hostedtoolcache/...)
          site_roots = []
          for pattern in (
              "usr/local/lib/python3.*",
              "usr/local/lib64/python3.*",
              "usr/lib/python3.*",
              "usr/lib64/python3.*",
              "opt/**/lib/python3.*",
              "opt/**/lib64/python3.*",
          ):
              site_roots.extend(root.glob(pattern))

          for sr in site_roots:
              sp = sr / "site-packages"
              if not sp.is_dir():
                  continue
              for item in sp.iterdir():
                  for target in targets:
                      copy_item(item, target / item.name)
          # Drop any stray /opt prefix left by the build environment
          opt_dir = root / "opt"
          if opt_dir.exists():
              shutil.rmtree(opt_dir, ignore_errors=True)
          PY
          ls -R pkgroot
      - name: Build .deb and .rpm
        run: |
          set -e
          VERSION="${GITHUB_REF##*/v}"
          DEB_DEPS=(
            python3
            python3-gi
            python3-gi-cairo
            python3-cairo
            python3-requests
            python3-psutil
            python3-setproctitle
            python3-pygments
            python3-regex
            gir1.2-gtk-4.0
            gir1.2-adw-1
            gir1.2-vte-3.91
            libgtk-4-1
            libadwaita-1-0
            libvte-2.91-gtk4-0
            libgtk-4-dev
            libadwaita-1-dev
            gobject-introspection
            rsync
            sshpass
          )
          RPM_DEPS=(
            python3-gobject
            python3-cairo
            python3-requests
            python3-psutil
            python3-setproctitle
            python3-pygments
            python3-regex
            gtk4
            libadwaita
            vte291-gtk4
            rsync
            sshpass
          )
          DEB_DEP_ARGS=()
          for dep in "${DEB_DEPS[@]}"; do
            DEB_DEP_ARGS+=(--depends "$dep")
          done
          RPM_DEP_ARGS=()
          for dep in "${RPM_DEPS[@]}"; do
            RPM_DEP_ARGS+=(--depends "$dep")
          done

          fpm -s dir -t deb \
            -n zashterm \
            -v "${VERSION}" \
            --iteration 1 \
            --architecture amd64 \
            --description "Zash terminal emulator" \
            "${DEB_DEP_ARGS[@]}" \
            -C pkgroot \
            --prefix / \
            .
      - name: Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: zashterm-deb
          path: |
            *.deb

  rpm:
    name: RPM via fpm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Build wheel
        run: |
          python -m pip install --upgrade pip
          python -m pip install build installer
          python -m build --wheel
      - name: Install fpm toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems build-essential rpm
          sudo gem install --no-document fpm
      - name: Stage files for packaging
        run: |
          set -e
          VERSION="${GITHUB_REF##*/v}"
          mkdir -p pkgroot
          python -m installer --destdir pkgroot dist/*.whl
          mkdir -p pkgroot/usr/bin pkgroot/usr/share
          cp -a usr/bin pkgroot/usr/
          cp -a usr/share pkgroot/usr/
          # Move/copy pure Python site-packages into distro-friendly paths (targeting Fedora py3.14)
          python - <<'PY'
          import pathlib, shutil, sys

          root = pathlib.Path("pkgroot")
          build_py_ver = f"{sys.version_info.major}.{sys.version_info.minor}"

          # Detect python versions seen in pkgroot and pick the highest as target (Fedora default today: 3.14)
          candidate_versions = set()
          candidate_versions.add(build_py_ver)
          for path in root.glob("usr/**/python3.*"):
              try:
                  candidate_versions.add(path.name.replace("python", ""))
              except Exception:
                  pass
          if "3.14" not in candidate_versions:
              candidate_versions.add("3.14")

          def ver_key(v: str):
              try:
                  return tuple(int(p) for p in v.split("."))
              except Exception:
                  return (0,)

          target_version = sorted(candidate_versions, key=ver_key)[-1]

          target_site_dirs = {
              root / f"usr/lib/python{target_version}/site-packages",
              root / f"usr/lib64/python{target_version}/site-packages",
          }
          for t in target_site_dirs:
              t.mkdir(parents=True, exist_ok=True)

          def copy_item(src: pathlib.Path, dest: pathlib.Path):
              if src.is_dir():
                  shutil.copytree(src, dest, dirs_exist_ok=True)
              else:
                  dest.parent.mkdir(parents=True, exist_ok=True)
                  shutil.copy2(src, dest)

          # Collect any site-packages produced under different prefixes (e.g., /opt/hostedtoolcache/...)
          site_roots = []
          for pattern in (
              "usr/local/lib/python3.*",
              "usr/local/lib64/python3.*",
              "usr/lib/python3.*",
              "usr/lib64/python3.*",
              "opt/**/lib/python3.*",
              "opt/**/lib64/python3.*",
          ):
              site_roots.extend(root.glob(pattern))

          for sr in site_roots:
              for pkg_dir_name in ("site-packages", "dist-packages"):
                  sp = sr / pkg_dir_name
                  if not sp.is_dir():
                      continue
                  for item in sp.iterdir():
                      for target in target_site_dirs:
                          copy_item(item, target / item.name)

          # Remove dist-packages everywhere (we only want site-packages owned by RPM)
          for dist_dir in root.glob("usr/**/dist-packages"):
              shutil.rmtree(dist_dir, ignore_errors=True)

          # Drop any stray /opt prefix left by the build environment
          opt_dir = root / "opt"
          if opt_dir.exists():
              shutil.rmtree(opt_dir, ignore_errors=True)

          # Remove any python3.* trees that are not the chosen target_version to avoid leftover files in the RPM
          for base in (root / "usr/lib", root / "usr/lib64"):
              if not base.exists():
                  continue
              for py_dir in base.glob("python3.*"):
                  if py_dir.name != f"python{target_version}":
                      shutil.rmtree(py_dir, ignore_errors=True)
          PY
          ls -R pkgroot
      - name: Build .rpm
        run: |
          set -e
          VERSION="${GITHUB_REF##*/v}"
          cat > cleanup-rpm.sh <<'EOF'
          #!/bin/bash
          rm -rf /usr/lib/python*/site-packages/zashterm \
                 /usr/lib64/python*/site-packages/zashterm \
                 /usr/lib/python*/site-packages/zashterm-*.dist-info \
                 /usr/lib64/python*/site-packages/zashterm-*.dist-info
          EOF
          chmod +x cleanup-rpm.sh
          RPM_DEPS=(
            python3-gobject
            python3-cairo
            python3-requests
            python3-psutil
            python3-setproctitle
            python3-pygments
            python3-regex
            gtk4
            libadwaita
            vte291-gtk4
            rsync
            sshpass
          )
          RPM_DEP_ARGS=()
          for dep in "${RPM_DEPS[@]}"; do
            RPM_DEP_ARGS+=(--depends "$dep")
          done

          fpm -s dir -t rpm \
            -n zashterm \
            -v "${VERSION}" \
            --iteration 1 \
            --architecture x86_64 \
            --description "Zashterm terminal emulator" \
            --after-remove cleanup-rpm.sh \
            "${RPM_DEP_ARGS[@]}" \
            -C pkgroot \
            --prefix / \
            .
      - name: Upload RPM
        uses: actions/upload-artifact@v4
        with:
          name: zashterm-rpm
          path: |
            *.rpm

  release:
    name: Publish Release Assets
    needs: [arch, deb, rpm]
    runs-on: ubuntu-latest
    if: ${{ startsWith(github.ref, 'refs/tags/') && always() }}
    steps:
      - name: Download Arch artifact
        uses: actions/download-artifact@v4
        if: ${{ needs.arch.result == 'success' }}
        with:
          name: zashterm-arch
          path: artifacts
      - name: Download DEB artifacts
        uses: actions/download-artifact@v4
        if: ${{ needs.deb.result == 'success' }}
        with:
          name: zashterm-deb
          path: artifacts
      - name: Download RPM artifacts
        uses: actions/download-artifact@v4
        if: ${{ needs.rpm.result == 'success' }}
        with:
          name: zashterm-rpm
          path: artifacts
      - name: Download RPM/SRPM artifacts
        uses: actions/download-artifact@v4
        if: ${{ needs.rpm_srpm.result == 'success' }}
        with:
          name: zashterm-rpm-srpm
          path: artifacts
      - name: Collect package files
        id: collect
        run: |
          set -e
          mkdir -p release
          find artifacts -type f \( -name "*.pkg.tar.*" -o -name "*.deb" -o -name "*.rpm" \) -exec cp {} release/ \; || true
          ls -l release || true
          FILES=$(find release -maxdepth 1 -type f \( -name "*.pkg.tar.*" -o -name "*.deb" -o -name "*.rpm" \) || true)
          if [ -z "$FILES" ]; then
            echo "No packages found to release."
            exit 1
          fi
          {
            echo "files<<EOF"
            echo "$FILES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
      - name: Publish GitHub Release assets
        uses: softprops/action-gh-release@v1
        if: ${{ needs.arch.result == 'success' || needs.deb.result == 'success' || needs.rpm.result == 'success' || needs.rpm_srpm.result == 'success' }}
        with:
          files: ${{ steps.collect.outputs.files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
