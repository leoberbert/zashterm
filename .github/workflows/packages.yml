name: Build Arch Package

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  arch:
    name: Arch PKGBUILD
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3
      - name: Build package inside Arch container
        run: |
          docker run --rm -v "$PWD:/workspace" -w /workspace archlinux:latest \
          bash -c "
            pacman -Syu --noconfirm git base-devel sudo &&
            pacman -S --noconfirm \
              python python-build python-installer python-uv-build python-wheel \
              gtk4 libadwaita vte4 libsecret rsync sshpass \
              python-gobject python-setproctitle python-requests python-psutil \
              python-regex python-pygments python-cairo gobject-introspection &&
            useradd -m builder &&
            echo 'builder ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers &&
            chown -R builder:builder /workspace &&
            cd pkgbuild &&
            sudo -u builder env PKGVER=${GITHUB_REF##*/v} PKGREL=1 makepkg -s --noconfirm
          "
          sudo chown -R $(id -u):$(id -g) .
      - name: Rename Arch package (drop pkgrel in filename)
        run: |
          set -e
          for f in pkgbuild/*.pkg.tar.zst; do
            base=$(basename "$f")
            new=${base/-1-/-}          # drop pkgrel
            new=${new/-any/_any}       # use underscore before arch
            if [ "$base" != "$new" ]; then
              mv "$f" "pkgbuild/$new"
            fi
          done
      - name: Upload Arch package
        uses: actions/upload-artifact@v4
        with:
          name: zashterm-arch
          path: pkgbuild/*.pkg.tar.zst
